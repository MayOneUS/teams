<!DOCTYPE html>
<html>
<head>
  <title>orm.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../", thisFile = "backend/wtforms/ext/sqlalchemy/orm.py", defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>orm.py</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tools for generating forms based on SQLAlchemy models.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">inspect</span>

<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">fields</span> <span class="k">as</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">wtforms.form</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span> <span class="nn">.fields</span> <span class="kn">import</span> <span class="n">QuerySelectField</span><span class="p">,</span> <span class="n">QuerySelectMultipleField</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;model_fields&#39;</span><span class="p">,</span> <span class="s">&#39;model_form&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">converts</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">_converter_for</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">_inner</span>


<span class="k">class</span> <span class="nc">ModelConversionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelConverterBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">converters</span><span class="p">,</span> <span class="n">use_mro</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_mro</span> <span class="o">=</span> <span class="n">use_mro</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">converters</span><span class="p">:</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;_converter_for&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">classname</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_converter_for</span><span class="p">:</span>
                    <span class="n">converters</span><span class="p">[</span><span class="n">classname</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="n">converters</span>

    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="n">db_session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;direction&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;direction&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s">&#39;Do not know how to convert multiple-column properties currently&#39;</span>
            <span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;validators&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">converter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">column</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;direction&#39;</span><span class="p">):</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Support sqlalchemy.schema.ColumnDefault, so users can benefit
from  setting defaults for fields, e.g.:
  field = Column(DateTimeField, default=datetime.utcnow)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

            <span class="n">default</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Only actually change default if it has an attribute named
'arg' that's callable.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="n">callable_default</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="s">&#39;arg&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">callable_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>ColumnDefault(val).arg can be also a plain value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="n">default</span> <span class="o">=</span> <span class="n">callable_default</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">callable_default</span><span class="p">)</span> <span class="k">else</span> <span class="n">callable_default</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>

            <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">Optional</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_mro</span><span class="p">:</span>
                <span class="n">types</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">type_string</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_type</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">col_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">type_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;sqlalchemy&#39;</span><span class="p">):</span>
                    <span class="n">type_string</span> <span class="o">=</span> <span class="n">type_string</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>

                <span class="k">if</span> <span class="n">type_string</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">:</span>
                    <span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="n">type_string</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col_type</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">:</span>
                        <span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="n">col_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ModelConversionError</span><span class="p">(</span><span class="s">&#39;Could not find field converter for </span><span class="si">%s</span><span class="s"> (</span><span class="si">%r</span><span class="s">).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>We have a property with a direction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db_session</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelConversionError</span><span class="p">(</span><span class="s">&quot;Cannot convert field </span><span class="si">%s</span><span class="s">, need DB session.&quot;</span> <span class="o">%</span> <span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

            <span class="n">foreign_model</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>

            <span class="n">nullable</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">prop</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                    <span class="n">nullable</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s">&#39;allow_blank&#39;</span><span class="p">:</span> <span class="n">nullable</span><span class="p">,</span>
                <span class="s">&#39;query_factory&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">foreign_model</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">})</span>

            <span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">field_args</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field_args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">converter</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
            <span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span>
            <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
            <span class="n">field_args</span><span class="o">=</span><span class="n">kwargs</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelConverter</span><span class="p">(</span><span class="n">ModelConverterBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_converters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_mro</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelConverter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">extra_converters</span><span class="p">,</span> <span class="n">use_mro</span><span class="o">=</span><span class="n">use_mro</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_string_common</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
            <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;String&#39;</span><span class="p">,</span> <span class="s">&#39;Unicode&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_String</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_string_common</span><span class="p">(</span><span class="n">field_args</span><span class="o">=</span><span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;types.Text&#39;</span><span class="p">,</span> <span class="s">&#39;UnicodeText&#39;</span><span class="p">,</span> <span class="s">&#39;types.LargeBinary&#39;</span><span class="p">,</span> <span class="s">&#39;types.Binary&#39;</span><span class="p">,</span> <span class="s">&#39;sql.sqltypes.Text&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_Text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_string_common</span><span class="p">(</span><span class="n">field_args</span><span class="o">=</span><span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">TextAreaField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;Boolean&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_Boolean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;Date&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_Date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;DateTime&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_DateTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;Enum&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_Enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;choices&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_args</span><span class="p">:</span>
            <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;choices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">enums</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">SelectField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;Integer&#39;</span><span class="p">,</span> <span class="s">&#39;SmallInteger&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_integer_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">unsigned</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;unsigned&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unsigned</span><span class="p">:</span>
            <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">NumberRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;Numeric&#39;</span><span class="p">,</span> <span class="s">&#39;Float&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_decimal_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">places</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;scale&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">places</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;places&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">places</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;databases.mysql.MSYear&#39;</span><span class="p">,</span> <span class="s">&#39;dialects.mysql.base.YEAR&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_MSYear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">NumberRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1901</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2155</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;databases.postgres.PGInet&#39;</span><span class="p">,</span> <span class="s">&#39;dialects.postgresql.base.INET&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_PGInet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">field_args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;label&#39;</span><span class="p">,</span> <span class="s">&#39;IP Address&#39;</span><span class="p">)</span>
        <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;dialects.postgresql.base.MACADDR&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_PGMacaddr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">field_args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;label&#39;</span><span class="p">,</span> <span class="s">&#39;MAC Address&#39;</span><span class="p">)</span>
        <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">MacAddress</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;dialects.postgresql.base.UUID&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_PGUuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">field_args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;label&#39;</span><span class="p">,</span> <span class="s">&#39;UUID&#39;</span><span class="p">)</span>
        <span class="n">field_args</span><span class="p">[</span><span class="s">&#39;validators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">UUID</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;MANYTOONE&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_ManyToOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QuerySelectField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>

    <span class="nd">@converts</span><span class="p">(</span><span class="s">&#39;MANYTOMANY&#39;</span><span class="p">,</span> <span class="s">&#39;ONETOMANY&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">conv_ManyToMany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QuerySelectMultipleField</span><span class="p">(</span><span class="o">**</span><span class="n">field_args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">model_fields</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">db_session</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">field_args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_pk</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">exclude_fk</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a dictionary of fields for a given SQLAlchemy model.</span>

<span class="sd">    See `model_form` docstring for description of parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_sa_class_manager</span><span class="o">.</span><span class="n">mapper</span>
    <span class="n">converter</span> <span class="o">=</span> <span class="n">converter</span> <span class="ow">or</span> <span class="n">ModelConverter</span><span class="p">()</span>
    <span class="n">field_args</span> <span class="o">=</span> <span class="n">field_args</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">iterate_properties</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;columns&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exclude_fk</span> <span class="ow">and</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">exclude_pk</span> <span class="ow">and</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="n">properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>((p.key, p) for p in mapper.iterate_properties)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="n">only</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">only</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">)</span>

    <span class="n">field_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span>
            <span class="n">field_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">db_session</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">field_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">return</span> <span class="n">field_dict</span>


<span class="k">def</span> <span class="nf">model_form</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">db_session</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="n">Form</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">field_args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_pk</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">exclude_fk</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">type_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a wtforms Form for a given SQLAlchemy model class::</span>

<span class="sd">        from wtalchemy.orm import model_form</span>
<span class="sd">        from myapp.models import User</span>
<span class="sd">        UserForm = model_form(User)</span>

<span class="sd">    :param model:</span>
<span class="sd">        A SQLAlchemy mapped model class.</span>
<span class="sd">    :param db_session:</span>
<span class="sd">        An optional SQLAlchemy Session.</span>
<span class="sd">    :param base_class:</span>
<span class="sd">        Base form class to extend from. Must be a ``wtforms.Form`` subclass.</span>
<span class="sd">    :param only:</span>
<span class="sd">        An optional iterable with the property names that should be included in</span>
<span class="sd">        the form. Only these properties will have fields.</span>
<span class="sd">    :param exclude:</span>
<span class="sd">        An optional iterable with the property names that should be excluded</span>
<span class="sd">        from the form. All other properties will have fields.</span>
<span class="sd">    :param field_args:</span>
<span class="sd">        An optional dictionary of field names mapping to keyword arguments used</span>
<span class="sd">        to construct each field object.</span>
<span class="sd">    :param converter:</span>
<span class="sd">        A converter to generate the fields based on the model properties. If</span>
<span class="sd">        not set, ``ModelConverter`` is used.</span>
<span class="sd">    :param exclude_pk:</span>
<span class="sd">        An optional boolean to force primary key exclusion.</span>
<span class="sd">    :param exclude_fk:</span>
<span class="sd">        An optional boolean to force foreign keys exclusion.</span>
<span class="sd">    :param type_name:</span>
<span class="sd">        An optional string to set returned type name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&#39;_sa_class_manager&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;model must be a sqlalchemy mapped model&#39;</span><span class="p">)</span>

    <span class="n">type_name</span> <span class="o">=</span> <span class="n">type_name</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&#39;Form&#39;</span><span class="p">)</span>
    <span class="n">field_dict</span> <span class="o">=</span> <span class="n">model_fields</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">db_session</span><span class="p">,</span> <span class="n">only</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">field_args</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span>
        <span class="n">exclude_pk</span><span class="o">=</span><span class="n">exclude_pk</span><span class="p">,</span> <span class="n">exclude_fk</span><span class="o">=</span><span class="n">exclude_fk</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">type_name</span><span class="p">,</span> <span class="p">(</span><span class="n">base_class</span><span class="p">,</span> <span class="p">),</span> <span class="n">field_dict</span><span class="p">)</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
