<!DOCTYPE html>
<html>
<head>
  <title>main.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "backend/main.py", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>main.py</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urlparse</span>

<span class="kn">import</span> <span class="nn">jinja2</span>
<span class="kn">import</span> <span class="nn">markdown</span>
<span class="kn">import</span> <span class="nn">webapp2</span>
<span class="kn">import</span> <span class="nn">wtforms</span>
<span class="kn">from</span> <span class="nn">wtforms.fields.html5</span> <span class="kn">import</span> <span class="n">IntegerField</span>
<span class="kn">from</span> <span class="nn">wtforms.widgets.html5</span> <span class="kn">import</span> <span class="n">URLInput</span>

<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">urlfetch</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">db</span>

<span class="kn">import</span> <span class="nn">config_NOCOMMIT</span>

<span class="n">PLEDGE_SERVICE_REQ</span> <span class="o">=</span> <span class="s">&quot;https://pledge.mayone.us&quot;</span>

<span class="n">JINJA</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
  <span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="s">&#39;templates/&#39;</span><span class="p">),</span>
  <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;jinja2.ext.autoescape&#39;</span><span class="p">],</span>
  <span class="n">autoescape</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">YOUTUBE_ID_VALIDATOR</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[\w\-]+$&#39;</span><span class="p">)</span>
<span class="n">INVALID_SLUG_CHARS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[^\w-]&#39;</span><span class="p">)</span>
<span class="n">MULTIDASH_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;-+&#39;</span><span class="p">)</span>
<span class="n">SLUG_TOKEN_AMOUNT</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">DEFAULT_DESC</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">Giving money to a super PAC is one of the last things I thought I&#39;d ever </span><span class="se">\</span>
<span class="s">do... but I just did.</span>

<span class="s">I recently joined Lawrence Lessig&#39;s citizen-funded Mayday PAC, an ambitious </span><span class="se">\</span>
<span class="s">campaign to win a Congress committed to ending corruption in 2016, and we did </span><span class="se">\</span>
<span class="s">something amazing: we raised $1 million dollars in 12 days. That&#39;s a ton of </span><span class="se">\</span>
<span class="s">money, but it&#39;s not enough.</span>

<span class="s">We&#39;re raising $5 million more, and I&#39;m writing to my friends and family to </span><span class="se">\</span>
<span class="s">ask if you can help us get the rest of the way there. If all of us who have </span><span class="se">\</span>
<span class="s">supported the Mayday PAC so far each recruit just five matching donation, </span><span class="se">\</span>
<span class="s">we&#39;d easily hit that goal. But I&#39;d like to see if I can recruit ten of my </span><span class="se">\</span>
<span class="s">friends to donate. So my question is: will you be one of those ten?</span>

<span class="s">I don&#39;t have to tell you why this is important. We all know our government is </span><span class="se">\</span>
<span class="s">dismally dysfunctional because politicians spend all their time raising money </span><span class="se">\</span>
<span class="s">instead of doing the jobs they were elected to do. So our plan is to fight </span><span class="se">\</span>
<span class="s">firewith fire: raise the money needed to elect representatives that are </span><span class="se">\</span>
<span class="s">committed to the reform we so desperately need.</span>

<span class="s">You can read all about the Mayday PAC from the links on this page, but once </span><span class="se">\</span>
<span class="s">you do, please consider joining me in making a pledge through my personalized </span><span class="se">\</span>
<span class="s">page here. This is a totally crazy plan, but now that we&#39;ve raised $1 million </span><span class="se">\</span>
<span class="s">I&#39;m beginning to think it&#39;s so crazy that it just might work. It&#39;d mean the </span><span class="se">\</span>
<span class="s">world to have your support.</span>

<span class="s">Thank you!</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="n">PREVIOUS_PLEDGE_DESC</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">Giving money to a super PAC is one of the last things I thought I&#39;d ever </span><span class="se">\</span>
<span class="s">do... but I just gave ${pledge_dollars}!</span>

<span class="s">I recently joined Lawrence Lessig&#39;s citizen-funded Mayday PAC, an ambitious </span><span class="se">\</span>
<span class="s">campaign to win a Congress committed to ending corruption in 2016, and we did </span><span class="se">\</span>
<span class="s">something amazing: we raised $1 million dollars in 12 days. That&#39;s a ton of </span><span class="se">\</span>
<span class="s">money, but it&#39;s not enough.</span>

<span class="s">We&#39;re raising $5 million more, and I&#39;m writing to my friends and family to </span><span class="se">\</span>
<span class="s">ask if you can help us get the rest of the way there. If all of us who have </span><span class="se">\</span>
<span class="s">supported the Mayday PAC so far each recruit just five matching donation, </span><span class="se">\</span>
<span class="s">we&#39;d easily hit that goal. But I&#39;d like to see if I can recruit ten of my </span><span class="se">\</span>
<span class="s">friends to donate. So my question is: will you be one of those ten?</span>

<span class="s">I don&#39;t have to tell you why this is important. We all know our government is </span><span class="se">\</span>
<span class="s">dismally dysfunctional because politicians spend all their time raising money </span><span class="se">\</span>
<span class="s">instead of doing the jobs they were elected to do. So our plan is to fight </span><span class="se">\</span>
<span class="s">firewith fire: raise the money needed to elect representatives that are </span><span class="se">\</span>
<span class="s">committed to the reform we so desperately need.</span>

<span class="s">You can read all about the Mayday PAC from the links on this page, but once </span><span class="se">\</span>
<span class="s">you do, please consider joining me in making a pledge through my personalized </span><span class="se">\</span>
<span class="s">page here. This is a totally crazy plan, but now that we&#39;ve raised $1 million </span><span class="se">\</span>
<span class="s">I&#39;m beginning to think it&#39;s so crazy that it just might work. It&#39;d mean the </span><span class="se">\</span>
<span class="s">world to have your support.</span>

<span class="s">{signature}</span>
<span class="s">&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>

  <span class="nd">@webapp2.cached_property</span>
  <span class="k">def</span> <span class="nf">auth_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config_NOCOMMIT</span><span class="o">.</span><span class="n">auth_service</span><span class="o">.</span><span class="n">requires_https</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;https&quot;</span>
    <span class="k">return</span> <span class="n">config_NOCOMMIT</span><span class="o">.</span><span class="n">auth_service</span><span class="o">.</span><span class="n">getAuthResponse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;auth&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_response</span><span class="p">[</span><span class="s">&quot;logged_in&quot;</span><span class="p">]</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">login_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;login_links&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">logout_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config_NOCOMMIT</span><span class="o">.</span><span class="n">auth_service</span><span class="o">.</span><span class="n">requires_https</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;https&quot;</span>
    <span class="k">return</span> <span class="n">config_NOCOMMIT</span><span class="o">.</span><span class="n">auth_service</span><span class="o">.</span><span class="n">getLogoutLink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">render_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logged_in</span><span class="p">:</span>
      <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;logged_in&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&quot;current_user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span>
        <span class="s">&quot;logout_link&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">logout_link</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;logged_in&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;login_links&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">login_links</span><span class="p">}</span>
    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">JINJA</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">notfound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">404</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;404.html&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Team</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="n">primary_slug</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">TextProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="n">goal_dollars</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">IntegerProperty</span><span class="p">()</span>
  <span class="n">youtube_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
  <span class="n">zip_code</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>for use with google.appengine.api.imagesget_serving_url</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="n">image</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BlobProperty</span><span class="p">()</span>

  <span class="n">user_token</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">YoutubeIdField</span><span class="p">(</span><span class="n">wtforms</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
  <span class="n">widget</span> <span class="o">=</span> <span class="n">URLInput</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">wtforms</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">validators</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">u&quot;https://www.youtube.com/watch?v=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">process_formdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valuelist</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">valuelist</span><span class="p">:</span>
      <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">valuelist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">if</span> <span class="s">&quot;youtube.com&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="s">&quot;Not a valid Youtube URL&quot;</span><span class="p">))</span>
      <span class="n">video_args</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;v&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="s">&quot;Not a valid Youtube URL&quot;</span><span class="p">))</span>
      <span class="n">youtube_id</span> <span class="o">=</span> <span class="n">video_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">YOUTUBE_ID_VALIDATOR</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">youtube_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="s">&quot;Not a valid Youtube URL&quot;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">youtube_id</span>


<span class="k">class</span> <span class="nc">ZipcodeField</span><span class="p">(</span><span class="n">wtforms</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A text field, except all input is coerced to an integer.  Erroneous input</span>
<span class="sd">  is ignored and will not be accepted as a value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">widget</span> <span class="o">=</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">TextInput</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">wtforms</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">validators</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">process_formdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valuelist</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">valuelist</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">valuelist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="s">&#39;Not a valid integer value&#39;</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">valuelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">TeamForm</span><span class="p">(</span><span class="n">wtforms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s">&quot;Title&quot;</span><span class="p">,</span> <span class="p">[</span>
      <span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">500</span><span class="p">)],</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;My Pledge Page&#39;</span><span class="p">)</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">TextAreaField</span><span class="p">(</span><span class="s">&quot;Description&quot;</span><span class="p">,</span> <span class="p">[</span>
      <span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_DESC</span><span class="p">)</span>

  <span class="n">goal_dollars</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="s">&quot;Goal&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">optional</span><span class="p">()])</span>
  <span class="n">youtube_id</span> <span class="o">=</span> <span class="n">YoutubeIdField</span><span class="p">(</span><span class="s">&quot;Youtube Video URL&quot;</span><span class="p">,</span> <span class="p">[</span>
      <span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">optional</span><span class="p">()])</span>
  <span class="n">zip_code</span> <span class="o">=</span> <span class="n">ZipcodeField</span><span class="p">(</span><span class="s">&quot;Zip Code&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">optional</span><span class="p">()])</span>


<span class="k">class</span> <span class="nc">Slug</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>the key is the slug name</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="n">team</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ReferenceProperty</span><span class="p">(</span><span class="n">Team</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="nd">@db.transactional</span>
  <span class="k">def</span> <span class="nf">_make</span><span class="p">(</span><span class="n">full_slug</span><span class="p">,</span> <span class="n">team</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">Slug</span><span class="o">.</span><span class="n">get_by_key_name</span><span class="p">(</span><span class="n">full_slug</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="n">Slug</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="n">full_slug</span><span class="p">,</span> <span class="n">team</span><span class="o">=</span><span class="n">team</span><span class="p">)</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">team</span><span class="p">):</span>
    <span class="n">slug_name</span> <span class="o">=</span> <span class="n">MULTIDASH_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">INVALID_SLUG_CHARS</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">team</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
    <span class="n">token_amount</span> <span class="o">=</span> <span class="n">SLUG_TOKEN_AMOUNT</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">slug_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">token_amount</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)</span>
      <span class="n">token_amount</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">full_slug</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slug_prefix</span><span class="p">,</span> <span class="n">slug_name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">Slug</span><span class="o">.</span><span class="n">_make</span><span class="p">(</span><span class="n">full_slug</span><span class="p">,</span> <span class="n">team</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">full_slug</span>


<span class="k">class</span> <span class="nc">AdminToTeam</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;This class represents an admin to team relationship, since it&#39;s</span>
<span class="sd">  many-to-many</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># from current_user[&quot;user_id&quot;]</span>
  <span class="n">team</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ReferenceProperty</span><span class="p">(</span><span class="n">Team</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">require_login</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
  <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">new_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logged_in</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">new_handler</span>


<span class="k">class</span> <span class="nc">IndexHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>TODO: shouldn't return all teams, should get list of top n</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;index.html&quot;</span><span class="p">,</span> <span class="n">teams</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">Team</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>


<span class="k">class</span> <span class="nc">NotFoundHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">notfound</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TeamBaseHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Slug</span><span class="o">.</span><span class="n">get_by_key_name</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">notfound</span><span class="p">()</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span>
    <span class="n">team</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">team</span>
    <span class="k">if</span> <span class="n">team</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">notfound</span><span class="p">()</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span>
    <span class="n">primary</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span> <span class="ow">and</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span> <span class="o">!=</span> <span class="n">slug</span><span class="p">:</span>
      <span class="n">primary</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logged_in</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">AdminToTeam</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&quot;team =&quot;</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
          <span class="s">&quot;user =&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&quot;user_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">is_admin</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">team</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">is_admin</span>


<span class="k">class</span> <span class="nc">TeamHandler</span><span class="p">(</span><span class="n">TeamBaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="n">team</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">is_admin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">team</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">primary</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_admin</span><span class="p">:</span>
      <span class="n">edit_url</span> <span class="o">=</span> <span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">/edit&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">edit_url</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span>
        <span class="s">&quot;show_team.html&quot;</span><span class="p">,</span> <span class="n">team</span><span class="o">=</span><span class="n">team</span><span class="p">,</span> <span class="n">edit_url</span><span class="o">=</span><span class="n">edit_url</span><span class="p">,</span>
        <span class="n">description_rendered</span><span class="o">=</span><span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="n">jinja2</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">team</span><span class="o">.</span><span class="n">description</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">LoginHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logged_in</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/dashboard&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;login.html&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DashboardHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="nd">@require_login</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">teams</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">team</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span>
             <span class="n">AdminToTeam</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;user =&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&quot;user_id&quot;</span><span class="p">])]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;dashboard.html&quot;</span><span class="p">,</span> <span class="n">teams</span><span class="o">=</span><span class="n">teams</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NewTeamHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="nd">@require_login</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;new_team.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">TeamForm</span><span class="p">())</span>

  <span class="nd">@require_login</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">TeamForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;new_team.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
    <span class="n">team</span> <span class="o">=</span> <span class="n">Team</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">goal_dollars</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">goal_dollars</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">youtube_id</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">youtube_id</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">zip_code</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">zip_code</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">team</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>TODO: can i reference a team before putting it in other reference
properties? should check</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="n">AdminToTeam</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&quot;user_id&quot;</span><span class="p">],</span> <span class="n">team</span><span class="o">=</span><span class="n">team</span><span class="p">)</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span> <span class="o">=</span> <span class="n">Slug</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
    <span class="n">team</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NewFromPledgeHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">add_to_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">team</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logged_in</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">AdminToTeam</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&quot;user =&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&quot;user_id&quot;</span><span class="p">])</span>\
          <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&quot;team =&quot;</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">AdminToTeam</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&quot;user_id&quot;</span><span class="p">],</span> <span class="n">team</span><span class="o">=</span><span class="n">team</span><span class="p">)</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_token</span><span class="p">):</span>
    <span class="n">team</span> <span class="o">=</span> <span class="n">Team</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;user_token =&#39;</span><span class="p">,</span> <span class="n">user_token</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">team</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="n">urlfetch</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
          <span class="s">&quot;</span><span class="si">%s</span><span class="s">/user-info/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PLEDGE_SERVICE_REQ</span><span class="p">,</span> <span class="n">user_token</span><span class="p">),</span>
          <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">validate_certificate</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notfound</span><span class="p">()</span>
        <span class="k">return</span>
      <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unexpected authentication error: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
      <span class="n">user_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s">&quot;user&quot;</span><span class="p">]</span>
      <span class="n">user_pledge_dollars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_info</span><span class="p">[</span><span class="s">&quot;pledge_amount_cents&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span>
      <span class="n">goal_dollars</span> <span class="o">=</span> <span class="n">user_pledge_dollars</span> <span class="o">*</span> <span class="mi">10</span>
      <span class="k">if</span> <span class="n">user_info</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]:</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="s">&quot;Thank you,</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">user_info</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="s">&quot;Thank you!&quot;</span>
      <span class="n">form</span> <span class="o">=</span> <span class="n">TeamForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span>
          <span class="s">&quot;goal_dollars&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">goal_dollars</span><span class="p">),</span>
          <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="n">user_info</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&quot;My Pledge Page&quot;</span><span class="p">,</span>
          <span class="s">&quot;zip_code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_info</span><span class="p">[</span><span class="s">&quot;zip_code&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
          <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="n">PREVIOUS_PLEDGE_DESC</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">pledge_dollars</span><span class="o">=</span><span class="n">user_pledge_dollars</span><span class="p">,</span>
              <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">)})</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">add_to_user</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
      <span class="n">form</span> <span class="o">=</span> <span class="n">TeamForm</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">team</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;new_from_pledge.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_token</span><span class="p">):</span>
    <span class="n">team</span> <span class="o">=</span> <span class="n">Team</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;user_token =&#39;</span><span class="p">,</span> <span class="n">user_token</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">TeamForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;new_from_pledge.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">team</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">team</span> <span class="o">=</span> <span class="n">Team</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                  <span class="n">zip_code</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">zip_code</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">user_token</span><span class="o">=</span><span class="n">user_token</span><span class="p">)</span>
      <span class="n">team</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_user</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
    <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span> <span class="o">=</span> <span class="n">Slug</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
    <span class="n">team</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EditTeamHandler</span><span class="p">(</span><span class="n">TeamBaseHandler</span><span class="p">):</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>require_login unneeded because we do the checking ourselves with validate</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="n">team</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">is_admin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">team</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">primary</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">/edit&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_admin</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;edit_team.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">TeamForm</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">team</span><span class="p">))</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>require_login unneeded because we do the checking ourselves with validate</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="n">team</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">is_admin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">team</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_admin</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">TeamForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">&quot;edit_team.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
    <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
    <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span> <span class="o">=</span> <span class="n">Slug</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
    <span class="n">team</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/t/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">team</span><span class="o">.</span><span class="n">primary_slug</span><span class="p">)</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">(</span><span class="n">config_NOCOMMIT</span><span class="o">.</span><span class="n">auth_service</span><span class="o">.</span><span class="n">handlers</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
  <span class="p">(</span><span class="s">r&#39;/t/([^/]+)/?&#39;</span><span class="p">,</span> <span class="n">TeamHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&#39;/t/([^/]+)/edit?&#39;</span><span class="p">,</span> <span class="n">EditTeamHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&#39;/login/?&#39;</span><span class="p">,</span> <span class="n">LoginHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&#39;/dashboard/?&#39;</span><span class="p">,</span> <span class="n">DashboardHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&#39;/dashboard/new/?&#39;</span><span class="p">,</span> <span class="n">NewTeamHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&#39;/dashboard/new_from_pledge/(\w+)&#39;</span><span class="p">,</span> <span class="n">NewFromPledgeHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&#39;/?&#39;</span><span class="p">,</span> <span class="n">IndexHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&#39;.*&#39;</span><span class="p">,</span> <span class="n">NotFoundHandler</span><span class="p">)],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
