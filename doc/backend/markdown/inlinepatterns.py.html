<!DOCTYPE html>
<html>
<head>
  <title>inlinepatterns.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "backend/markdown/inlinepatterns.py", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>inlinepatterns.py</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">INLINE PATTERNS</span>
<span class="sd">=============================================================================</span>

<span class="sd">Inline patterns such as *emphasis* are handled by means of auxiliary</span>
<span class="sd">objects, one per pattern.  Pattern objects must be instances of classes</span>
<span class="sd">that extend markdown.Pattern.  Each pattern object uses a single regular</span>
<span class="sd">expression and needs support the following methods:</span>

<span class="sd">    pattern.getCompiledRegExp() # returns a regular expression</span>

<span class="sd">    pattern.handleMatch(m) # takes a match object and returns</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>an ElementTree element or just plain text</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="sd">All of python markdown&#39;s built-in patterns subclass from Pattern,</span>
<span class="sd">but you can add additional patterns that don&#39;t.</span>

<span class="sd">Also note that all the regular expressions used by inline must</span>
<span class="sd">capture the whole block.  For this reason, they all start with</span>
<span class="sd">&#39;^(.*)&#39; and end with &#39;(.*)!&#39;.  In case with built-in expression</span>
<span class="sd">Pattern takes care of adding the &quot;^(.*)&quot; and &quot;(.*)!&quot;.</span>

<span class="sd">Finally, the order in which regular expressions are applied is very</span>
<span class="sd">important - e.g. if we first replace http://.../ links with &lt;a&gt; tags</span>
<span class="sd">and _then_ try to replace inline html, we would end up with a mess.</span>
<span class="sd">So, we apply the expressions in the following order:</span>

<span class="sd">* escape and backticks have to go before everything else, so</span>
<span class="sd">  that we can preempt any markdown patterns by escaping them.</span>

<span class="sd">* then we handle auto-links (must be done before inline html)</span>

<span class="sd">* then we handle inline HTML.  At this point we will simply</span>
<span class="sd">  replace all inline HTML strings with a placeholder and add</span>
<span class="sd">  the actual HTML to a hash.</span>

<span class="sd">* then inline images (must be done before links)</span>

<span class="sd">* then bracketed links, first regular then reference-style</span>

<span class="sd">* finally we apply strong and emphasis</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">odict</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlunparse</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlunparse</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">entities</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">htmlentitydefs</span> <span class="kn">as</span> <span class="nn">entities</span>


<span class="k">def</span> <span class="nf">build_inlinepatterns</span><span class="p">(</span><span class="n">md_instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Build the default set of inline patterns for Markdown. &quot;&quot;&quot;</span>
    <span class="n">inlinePatterns</span> <span class="o">=</span> <span class="n">odict</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;backtick&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BacktickPattern</span><span class="p">(</span><span class="n">BACKTICK_RE</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;escape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EscapePattern</span><span class="p">(</span><span class="n">ESCAPE_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReferencePattern</span><span class="p">(</span><span class="n">REFERENCE_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinkPattern</span><span class="p">(</span><span class="n">LINK_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;image_link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImagePattern</span><span class="p">(</span><span class="n">IMAGE_LINK_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;image_reference&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">ImageReferencePattern</span><span class="p">(</span><span class="n">IMAGE_REFERENCE_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;short_reference&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">ReferencePattern</span><span class="p">(</span><span class="n">SHORT_REF_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;autolink&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutolinkPattern</span><span class="p">(</span><span class="n">AUTOLINK_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;automail&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutomailPattern</span><span class="p">(</span><span class="n">AUTOMAIL_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;linebreak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubstituteTagPattern</span><span class="p">(</span><span class="n">LINE_BREAK_RE</span><span class="p">,</span> <span class="s">&#39;br&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">md_instance</span><span class="o">.</span><span class="n">safeMode</span> <span class="o">!=</span> <span class="s">&#39;escape&#39;</span><span class="p">:</span>
        <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;html&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HtmlPattern</span><span class="p">(</span><span class="n">HTML_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;entity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HtmlPattern</span><span class="p">(</span><span class="n">ENTITY_RE</span><span class="p">,</span> <span class="n">md_instance</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;not_strong&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SimpleTextPattern</span><span class="p">(</span><span class="n">NOT_STRONG_RE</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;strong_em&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DoubleTagPattern</span><span class="p">(</span><span class="n">STRONG_EM_RE</span><span class="p">,</span> <span class="s">&#39;strong,em&#39;</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;strong&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SimpleTagPattern</span><span class="p">(</span><span class="n">STRONG_RE</span><span class="p">,</span> <span class="s">&#39;strong&#39;</span><span class="p">)</span>
    <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;emphasis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SimpleTagPattern</span><span class="p">(</span><span class="n">EMPHASIS_RE</span><span class="p">,</span> <span class="s">&#39;em&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">md_instance</span><span class="o">.</span><span class="n">smart_emphasis</span><span class="p">:</span>
        <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;emphasis2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SimpleTagPattern</span><span class="p">(</span><span class="n">SMART_EMPHASIS_RE</span><span class="p">,</span> <span class="s">&#39;em&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inlinePatterns</span><span class="p">[</span><span class="s">&quot;emphasis2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SimpleTagPattern</span><span class="p">(</span><span class="n">EMPHASIS_2_RE</span><span class="p">,</span> <span class="s">&#39;em&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inlinePatterns</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The actual regular expressions for patterns</span>
<span class="sd">-----------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">NOBRACKET</span> <span class="o">=</span> <span class="s">r&#39;[^\]\[]*&#39;</span>
<span class="n">BRK</span> <span class="o">=</span> <span class="p">(</span> <span class="s">r&#39;\[(&#39;</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">NOBRACKET</span> <span class="o">+</span> <span class="s">r&#39;(\[&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">NOBRACKET</span><span class="o">+</span> <span class="s">r&#39;\])*&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span>
        <span class="o">+</span> <span class="n">NOBRACKET</span> <span class="o">+</span> <span class="s">r&#39;)\]&#39;</span> <span class="p">)</span>
<span class="n">NOIMG</span> <span class="o">=</span> <span class="s">r&#39;(?&lt;!\!)&#39;</span>

<span class="n">BACKTICK_RE</span> <span class="o">=</span> <span class="s">r&#39;(?&lt;!</span><span class="se">\\</span><span class="s">)(`+)(.+?)(?&lt;!`)\2(?!`)&#39;</span> <span class="c"># `e=f()` or ``e=f(&quot;`&quot;)``</span>
<span class="n">ESCAPE_RE</span> <span class="o">=</span> <span class="s">r&#39;</span><span class="se">\\</span><span class="s">(.)&#39;</span>                             <span class="c"># \&lt;</span>
<span class="n">EMPHASIS_RE</span> <span class="o">=</span> <span class="s">r&#39;(\*)([^\*]+)\2&#39;</span>                    <span class="c"># *emphasis*</span>
<span class="n">STRONG_RE</span> <span class="o">=</span> <span class="s">r&#39;(\*{2}|_{2})(.+?)\2&#39;</span>                      <span class="c"># **strong**</span>
<span class="n">STRONG_EM_RE</span> <span class="o">=</span> <span class="s">r&#39;(\*{3}|_{3})(.+?)\2&#39;</span>            <span class="c"># ***strong***</span>
<span class="n">SMART_EMPHASIS_RE</span> <span class="o">=</span> <span class="s">r&#39;(?&lt;!\w)(_)(?!_)(.+?)(?&lt;!_)\2(?!\w)&#39;</span>  <span class="c"># _smart_emphasis_</span>
<span class="n">EMPHASIS_2_RE</span> <span class="o">=</span> <span class="s">r&#39;(_)(.+?)\2&#39;</span>                 <span class="c"># _emphasis_</span>
<span class="n">LINK_RE</span> <span class="o">=</span> <span class="n">NOIMG</span> <span class="o">+</span> <span class="n">BRK</span> <span class="o">+</span> \
<span class="sd">r&#39;&#39;&#39;\(\s*(&lt;.*?&gt;|((?:(?:\(.*?\))|[^\(\)]))*?)\s*(([&#39;&quot;])(.*?)\12\s*)?\)&#39;&#39;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p><a href="url">text</a> or <a href="url">text</a> or <a href="url" title="title">text</a></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="n">IMAGE_LINK_RE</span> <span class="o">=</span> <span class="s">r&#39;\!&#39;</span> <span class="o">+</span> <span class="n">BRK</span> <span class="o">+</span> <span class="s">r&#39;\s*\((&lt;.*?&gt;|([^&quot;)]+&quot;[^&quot;]*&quot;|[^\)]*))\)&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p><img src="http://x.com/" alt="alttxt" title="" /> or <img src="http://x.com/" alt="alttxt" title="" /></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="n">REFERENCE_RE</span> <span class="o">=</span> <span class="n">NOIMG</span> <span class="o">+</span> <span class="n">BRK</span><span class="o">+</span> <span class="s">r&#39;\s?\[([^\]]*)\]&#39;</span>           <span class="c"># [Google][3]</span>
<span class="n">SHORT_REF_RE</span> <span class="o">=</span> <span class="n">NOIMG</span> <span class="o">+</span> <span class="s">r&#39;\[([^\]]+)\]&#39;</span>                   <span class="c"># [Google]</span>
<span class="n">IMAGE_REFERENCE_RE</span> <span class="o">=</span> <span class="s">r&#39;\!&#39;</span> <span class="o">+</span> <span class="n">BRK</span> <span class="o">+</span> <span class="s">&#39;\s?\[([^\]]*)\]&#39;</span> <span class="c"># ![alt text][2]</span>
<span class="n">NOT_STRONG_RE</span> <span class="o">=</span> <span class="s">r&#39;((^| )(\*|_)( |$))&#39;</span>                        <span class="c"># stand-alone * or _</span>
<span class="n">AUTOLINK_RE</span> <span class="o">=</span> <span class="s">r&#39;&lt;((?:[Ff]|[Hh][Tt])[Tt][Pp][Ss]?://[^&gt;]*)&gt;&#39;</span> <span class="c"># &lt;http://www.123.com&gt;</span>
<span class="n">AUTOMAIL_RE</span> <span class="o">=</span> <span class="s">r&#39;&lt;([^&gt; \!]*@[^&gt; ]*)&gt;&#39;</span>               <span class="c"># &lt;me@example.com&gt;</span>

<span class="n">HTML_RE</span> <span class="o">=</span> <span class="s">r&#39;(\&lt;([a-zA-Z/][^\&gt;]*?|\!--.*?--)\&gt;)&#39;</span>               <span class="c"># &lt;...&gt;</span>
<span class="n">ENTITY_RE</span> <span class="o">=</span> <span class="s">r&#39;(&amp;[\#a-zA-Z0-9]*;)&#39;</span>               <span class="c"># &amp;amp;</span>
<span class="n">LINE_BREAK_RE</span> <span class="o">=</span> <span class="s">r&#39;  \n&#39;</span>                     <span class="c"># two spaces at end of line</span>


<span class="k">def</span> <span class="nf">dequote</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove quotes from around a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">string</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">))</span>
         <span class="ow">or</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">string</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">))</span> <span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span>

<span class="n">ATTR_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;\{@([^\}]*)=([^\}]*)}&quot;</span><span class="p">)</span> <span class="c"># {@id=123}</span>

<span class="k">def</span> <span class="nf">handleAttributes</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set values of an element based on attribute definitions ({@id=123}).&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">attributeCallback</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ATTR_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">attributeCallback</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The pattern classes</span>
<span class="sd">-----------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Pattern</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class that inline patterns subclass. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">markdown_instance</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instant of an inline pattern.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        * pattern: A regular expression that matches a pattern</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^(.*?)</span><span class="si">%s</span><span class="s">(.*?)$&quot;</span> <span class="o">%</span> <span class="n">pattern</span><span class="p">,</span> 
                                      <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Api for Markdown to pass safe_mode into instance</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe_mode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">markdown_instance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span> <span class="o">=</span> <span class="n">markdown_instance</span>

    <span class="k">def</span> <span class="nf">getCompiledRegExp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a compiled regular expression. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_re</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a ElementTree element from the given match.</span>

<span class="sd">        Subclasses should override this method.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        * m: A re match object containing a match of the pattern.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return class name, to define pattern type &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>

    <span class="k">def</span> <span class="nf">unescape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return unescaped text given text with an inline placeholder. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">treeprocessors</span><span class="p">[</span><span class="s">&#39;inline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stashed_nodes</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text</span>
        <span class="k">def</span> <span class="nf">itertext</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
            <span class="s">&#39; Reimplement Element.itertext for older python versions &#39;</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">el</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">itertext</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">s</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">e</span><span class="o">.</span><span class="n">tail</span>
        <span class="k">def</span> <span class="nf">get_stash</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">stash</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">stash</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>An etree Element - return text content only</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">itertext</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> 
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">INLINE_PLACEHOLDER_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">get_stash</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SimpleTextPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a simple text of group(2) of a Pattern. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="n">util</span><span class="o">.</span><span class="n">INLINE_PLACEHOLDER_PREFIX</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">text</span>


<span class="k">class</span> <span class="nc">EscapePattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return an escaped character. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">ESCAPED_CHARS</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">STX</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">),</span> <span class="n">util</span><span class="o">.</span><span class="n">ETX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span> 


<span class="k">class</span> <span class="nc">SimpleTagPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return element of type `tag` with a text attribute of group(3)</span>
<span class="sd">    of a Pattern.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="n">Pattern</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">el</span>


<span class="k">class</span> <span class="nc">SubstituteTagPattern</span><span class="p">(</span><span class="n">SimpleTagPattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return an element of type `tag` with no children. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BacktickPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a `&lt;code&gt;` element containing the matching text. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="n">Pattern</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;code&quot;</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">el</span>


<span class="k">class</span> <span class="nc">DoubleTagPattern</span><span class="p">(</span><span class="n">SimpleTagPattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a ElementTree element nested in tag2 nested in tag1.</span>

<span class="sd">    Useful for strong emphasis etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">tag1</span><span class="p">,</span> <span class="n">tag2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">el1</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">tag1</span><span class="p">)</span>
        <span class="n">el2</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">el1</span><span class="p">,</span> <span class="n">tag2</span><span class="p">)</span>
        <span class="n">el2</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">el1</span>


<span class="k">class</span> <span class="nc">HtmlPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Store raw inline html and return a placeholder. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">rawhtml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">place_holder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">htmlStash</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">rawhtml</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">place_holder</span>

    <span class="k">def</span> <span class="nf">unescape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return unescaped text given text with an inline placeholder. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">treeprocessors</span><span class="p">[</span><span class="s">&#39;inline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stashed_nodes</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text</span>
        <span class="k">def</span> <span class="nf">get_stash</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">stash</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">serializer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&#39;\</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span>
            
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">INLINE_PLACEHOLDER_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">get_stash</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LinkPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a link element from the given match. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">href</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">href</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&lt;&quot;</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">href</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">href</span><span class="o">.</span><span class="n">strip</span><span class="p">())))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">dequote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">title</span><span class="p">))</span> 
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">el</span>

    <span class="k">def</span> <span class="nf">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sanitize a url against xss attacks in &quot;safe_mode&quot;.</span>

<span class="sd">        Rather than specifically blacklisting `javascript:alert(&quot;XSS&quot;)` and all</span>
<span class="sd">        its aliases (see &lt;http://ha.ckers.org/xss.html&gt;), we whitelist known</span>
<span class="sd">        safe url formats. Most urls contain a network location, however some</span>
<span class="sd">        are known not to (i.e.: mailto links). Script urls do not contain a</span>
<span class="sd">        location. Additionally, for `javascript:...`, the scheme would be</span>
<span class="sd">        &quot;javascript&quot; but some aliases will appear to `urlparse()` to have no</span>
<span class="sd">        scheme. On top of that relative links (i.e.: &quot;foo/bar.html&quot;) have no</span>
<span class="sd">        scheme. Therefore we must check &quot;path&quot;, &quot;parameters&quot;, &quot;query&quot; and</span>
<span class="sd">        &quot;fragment&quot; for any literal colons. We don&#39;t check &quot;scheme&quot; for colons</span>
<span class="sd">        because it *should* never have any and &quot;netloc&quot; must allow the form:</span>
<span class="sd">        `username:password@host:port`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">safeMode</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Return immediately bipassing parsing.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="n">url</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Bad url - so bad it couldn't be parsed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        
        <span class="n">locless_schemes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;mailto&#39;</span><span class="p">,</span> <span class="s">&#39;news&#39;</span><span class="p">]</span>
        <span class="n">allowed_schemes</span> <span class="o">=</span> <span class="n">locless_schemes</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">,</span> <span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;ftps&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_schemes</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Not a known (allowed) scheme. Not safe.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
            
        <span class="k">if</span> <span class="n">netloc</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">locless_schemes</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>This should not happen. Treat as suspect.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">url</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>A colon in "path", "parameters", "query" or "fragment" is suspect.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">return</span> <span class="s">&#39;&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Url passes all tests. Return url as-is.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">return</span> <span class="n">urlunparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagePattern</span><span class="p">(</span><span class="n">LinkPattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a img element from the given match. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;img&quot;</span><span class="p">)</span>
        <span class="n">src_parts</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">src_parts</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">src_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&lt;&quot;</span> <span class="ow">and</span> <span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&gt;&quot;</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">src</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">dequote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">enable_attributes</span><span class="p">:</span>
            <span class="n">truealt</span> <span class="o">=</span> <span class="n">handleAttributes</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">el</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">truealt</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;alt&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">truealt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">el</span>

<span class="k">class</span> <span class="nc">ReferencePattern</span><span class="p">(</span><span class="n">LinkPattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Match to a stored reference and return link element. &quot;&quot;&quot;</span>

    <span class="n">NEWLINE_CLEANUP_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[ ]?\n&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>if we got something like "[Google][]" or "[Goggle]"
we'll use "google" as the id</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Clean up linebreaks in id</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NEWLINE_CLEANUP_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">references</span><span class="p">:</span> <span class="c"># ignore undefined refs</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">href</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeTag</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makeTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>

        <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">href</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

        <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">el</span>


<span class="k">class</span> <span class="nc">ImageReferencePattern</span><span class="p">(</span><span class="n">ReferencePattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Match to a stored reference and return img element. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">makeTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;img&quot;</span><span class="p">)</span>
        <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;src&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">href</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">enable_attributes</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">handleAttributes</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>

        <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;alt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">el</span>


<span class="k">class</span> <span class="nc">AutolinkPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a link Element given an autolink (`&lt;http://example/com&gt;`). &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">el</span>

<span class="k">class</span> <span class="nc">AutomailPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a mailto link Element given an automail link (`&lt;foo@example.com&gt;`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">email</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;mailto:&quot;</span><span class="p">):</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;mailto:&quot;</span><span class="p">):]</span>

        <span class="k">def</span> <span class="nf">codepoint2name</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Return entity definition by code, or the code if not defined.&quot;&quot;&quot;</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">codepoint2name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entity</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">AMP_SUBSTITUTE</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%d</span><span class="s">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">AMP_SUBSTITUTE</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

        <span class="n">letters</span> <span class="o">=</span> <span class="p">[</span><span class="n">codepoint2name</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="p">))</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">email</span><span class="p">]</span>
        <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">letters</span><span class="p">))</span>

        <span class="n">mailto</span> <span class="o">=</span> <span class="s">&quot;mailto:&quot;</span> <span class="o">+</span> <span class="n">email</span>
        <span class="n">mailto</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">util</span><span class="o">.</span><span class="n">AMP_SUBSTITUTE</span> <span class="o">+</span> <span class="s">&#39;#</span><span class="si">%d</span><span class="s">;&#39;</span> <span class="o">%</span>
                          <span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">mailto</span><span class="p">])</span>
        <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="n">mailto</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">el</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
