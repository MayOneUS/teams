<!DOCTYPE html>
<html>
<head>
  <title>form.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "build/wtforms/form.py", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>form.py</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">itertools</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ordereddict</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">wtforms.compat</span> <span class="kn">import</span> <span class="n">with_metaclass</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">itervalues</span>
<span class="kn">from</span> <span class="nn">wtforms.meta</span> <span class="kn">import</span> <span class="n">DefaultMeta</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;BaseForm&#39;</span><span class="p">,</span>
    <span class="s">&#39;Form&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseForm</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base Form Class.  Provides core behaviour like field construction,</span>
<span class="sd">    validation, and data and error proxying.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">DefaultMeta</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param fields:</span>
<span class="sd">            A dict or sequence of 2-tuples of partially-constructed fields.</span>
<span class="sd">        :param prefix:</span>
<span class="sd">            If provided, all fields will have their name prefixed with the</span>
<span class="sd">            value.</span>
<span class="sd">        :param meta:</span>
<span class="sd">            A meta instance which is used for configuration and customization</span>
<span class="sd">            of WTForms behaviors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;-_;:/.&#39;</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="s">&#39;-&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="n">translations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_translations</span><span class="p">()</span>
        <span class="n">extra_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">csrf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_csrf</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">build_csrf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">extra_fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csrf</span><span class="o">.</span><span class="n">setup_form</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">unbound_field</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">extra_fields</span><span class="p">):</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">translations</span><span class="o">=</span><span class="n">translations</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">bind_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unbound_field</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate form fields in creation order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns `True` if the named field is a member of this form. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Dict-style access to this form&#39;s fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Bind a field to this form. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove a field from this form. &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 2.0</span>
<span class="sd">            `_get_translations` is being removed in WTForms 3.0, use</span>
<span class="sd">            `Meta.get_translations` instead.</span>

<span class="sd">        Override in subclasses to provide alternate translations factory.</span>

<span class="sd">        Must return an object that provides gettext() and ngettext() methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">populate_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates the attributes of the passed `obj` with data from the form&#39;s</span>
<span class="sd">        fields.</span>

<span class="sd">        :note: This is a destructive operation; Any attribute with the same name</span>
<span class="sd">               as a field will be overridden. Use with caution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
            <span class="n">field</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formdata</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take form, object data, and keyword arg input and have the fields</span>
<span class="sd">        process them.</span>

<span class="sd">        :param formdata:</span>
<span class="sd">            Used to pass data coming from the enduser, usually `request.POST` or</span>
<span class="sd">            equivalent.</span>
<span class="sd">        :param obj:</span>
<span class="sd">            If `formdata` is empty or not provided, this object is checked for</span>
<span class="sd">            attributes matching form field names, which will be used for field</span>
<span class="sd">            values.</span>
<span class="sd">        :param data:</span>
<span class="sd">            If provided, must be a dictionary of data. This is only used if</span>
<span class="sd">            `formdata` is empty or not provided and `obj` does not contain</span>
<span class="sd">            an attribute named the same as the field.</span>
<span class="sd">        :param `**kwargs`:</span>
<span class="sd">            If `formdata` is empty or not provided and `obj` does not contain</span>
<span class="sd">            an attribute named the same as a field, form will assign the value</span>
<span class="sd">            of a matching keyword argument to the field, if one exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">formdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wrap_formdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>XXX we want to eventually process 'data' as a new entity.
    Temporarily, this can simply be merged with kwargs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">field</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">formdata</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">formdata</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">formdata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_validators</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the form by calling `validate` on each field.</span>

<span class="sd">        :param extra_validators:</span>
<span class="sd">            If provided, is a dict mapping field names to a sequence of</span>
<span class="sd">            callables which will be passed as extra validators to the field&#39;s</span>
<span class="sd">            `validate` method.</span>

<span class="sd">        Returns `True` if no errors occur.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">success</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">extra_validators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">extra_validators</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="n">extra_validators</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra</span><span class="p">):</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">success</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span>


<span class="k">class</span> <span class="nc">FormMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The metaclass for `Form` and any subclasses of `Form`.</span>

<span class="sd">    `FormMeta`&#39;s responsibility is to create the `_unbound_fields` list, which</span>
<span class="sd">    is a list of `UnboundField` instances sorted by their order of</span>
<span class="sd">    instantiation.  The list is created at the first instantiation of the form.</span>
<span class="sd">    If any fields are added/removed from the form, the list is cleared to be</span>
<span class="sd">    re-generated on the next instantiaton.</span>

<span class="sd">    Any properties which begin with an underscore or are not `UnboundField`</span>
<span class="sd">    instances are ignored by the metaclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="nb">type</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_unbound_fields</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_wtforms_meta</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a new `Form` instance.</span>

<span class="sd">        Creates the `_unbound_fields` list and the internal `_wtforms_meta`</span>
<span class="sd">        subclass of the class Meta in order to allow a proper inheritance</span>
<span class="sd">        hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">_unbound_fields</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
                    <span class="n">unbound_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">unbound_field</span><span class="p">,</span> <span class="s">&#39;_formfield&#39;</span><span class="p">):</span>
                        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">unbound_field</span><span class="p">))</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>We keep the name as the second element of the sort
to ensure a stable sort.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="n">fields</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">creation_counter</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_unbound_fields</span> <span class="o">=</span> <span class="n">fields</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Create a subclass of the 'class Meta' using all the ancestors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">_wtforms_meta</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mro_class</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__mro__</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;Meta&#39;</span> <span class="ow">in</span> <span class="n">mro_class</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
                    <span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mro_class</span><span class="o">.</span><span class="n">Meta</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_wtforms_meta</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;Meta&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bases</span><span class="p">),</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an attribute to the class, clearing `_unbound_fields` if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Meta&#39;</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_wtforms_meta</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;_formfield&#39;</span><span class="p">):</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_unbound_fields</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">type</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove an attribute from the class, clearing `_unbound_fields` if</span>
<span class="sd">        needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_unbound_fields</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">type</span><span class="o">.</span><span class="n">__delattr__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Form</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">FormMeta</span><span class="p">,</span> <span class="n">BaseForm</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Declarative Form base class. Extends BaseForm&#39;s core behaviour allowing</span>
<span class="sd">    fields to be defined on Form subclasses as class attributes.</span>

<span class="sd">    In addition, form and instance input data are taken at construction time</span>
<span class="sd">    and passed to `process()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Meta</span> <span class="o">=</span> <span class="n">DefaultMeta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formdata</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param formdata:</span>
<span class="sd">            Used to pass data coming from the enduser, usually `request.POST` or</span>
<span class="sd">            equivalent. formdata should be some sort of request-data wrapper which</span>
<span class="sd">            can get multiple parameters from the form input, and values are unicode</span>
<span class="sd">            strings, e.g. a Werkzeug/Django/WebOb MultiDict</span>
<span class="sd">        :param obj:</span>
<span class="sd">            If `formdata` is empty or not provided, this object is checked for</span>
<span class="sd">            attributes matching form field names, which will be used for field</span>
<span class="sd">            values.</span>
<span class="sd">        :param prefix:</span>
<span class="sd">            If provided, all fields will have their name prefixed with the</span>
<span class="sd">            value.</span>
<span class="sd">        :param data:</span>
<span class="sd">            Accept a dictionary of data. This is only used if `formdata` and</span>
<span class="sd">            `obj` are not present.</span>
<span class="sd">        :param meta:</span>
<span class="sd">            If provided, this is a dictionary of values to override attributes</span>
<span class="sd">            on this form&#39;s meta instance.</span>
<span class="sd">        :param `**kwargs`:</span>
<span class="sd">            If `formdata` is empty or not provided and `obj` does not contain</span>
<span class="sd">            an attribute named the same as a field, form will assign the value</span>
<span class="sd">            of a matching keyword argument to the field, if one exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wtforms_meta</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">meta_obj</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Form</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unbound_fields</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta_obj</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Set all the fields to attributes so that they obscure the class
attributes with the same names.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">formdata</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Fields may not be added to Form instances, only classes.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>This is done for idempotency, if we have a name which is a field,
we want to mask it by setting the value to None.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="n">unbound_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unbound_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">unbound_field</span><span class="p">,</span> <span class="s">&#39;_formfield&#39;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Form</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__delattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the form by calling `validate` on each field, passing any</span>
<span class="sd">        extra `Form.validate_&lt;fieldname&gt;` validators to the field validator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">inline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="s">&#39;validate_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">extra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inline</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Form</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
