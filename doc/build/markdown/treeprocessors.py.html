<!DOCTYPE html>
<html>
<head>
  <title>treeprocessors.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "build/markdown/treeprocessors.py", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>treeprocessors.py</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">odict</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">inlinepatterns</span>


<span class="k">def</span> <span class="nf">build_treeprocessors</span><span class="p">(</span><span class="n">md_instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Build the default treeprocessors for Markdown. &quot;&quot;&quot;</span>
    <span class="n">treeprocessors</span> <span class="o">=</span> <span class="n">odict</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">treeprocessors</span><span class="p">[</span><span class="s">&quot;inline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InlineProcessor</span><span class="p">(</span><span class="n">md_instance</span><span class="p">)</span>
    <span class="n">treeprocessors</span><span class="p">[</span><span class="s">&quot;prettify&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PrettifyTreeprocessor</span><span class="p">(</span><span class="n">md_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">treeprocessors</span>


<span class="k">def</span> <span class="nf">isString</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check if it&#39;s string &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">Treeprocessor</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Processor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Treeprocessors are run on the ElementTree object before serialization.</span>

<span class="sd">    Each Treeprocessor implements a &quot;run&quot; method that takes a pointer to an</span>
<span class="sd">    ElementTree, modifies it as necessary and returns an ElementTree</span>
<span class="sd">    object.</span>

<span class="sd">    Treeprocessors must extend markdown.Treeprocessor.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclasses of Treeprocessor should implement a `run` method, which</span>
<span class="sd">        takes a root ElementTree. This method can return another ElementTree </span>
<span class="sd">        object, and the existing root ElementTree will be replaced, or it can </span>
<span class="sd">        modify the current tree and return None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">InlineProcessor</span><span class="p">(</span><span class="n">Treeprocessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Treeprocessor that traverses a tree, applying inline patterns.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_prefix</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">INLINE_PLACEHOLDER_PREFIX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_suffix</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">ETX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_length</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_prefix</span><span class="p">)</span> \
                                      <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_re</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">INLINE_PLACEHOLDER_RE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span> <span class="o">=</span> <span class="n">md</span>

    <span class="k">def</span> <span class="nf">__makePlaceholder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate a placeholder &quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%04d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stashed_nodes</span><span class="p">)</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">INLINE_PLACEHOLDER</span> <span class="o">%</span> <span class="nb">id</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">,</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">__findPlaceholder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract id from data string, start from index</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        * data: string</span>
<span class="sd">        * index: index, from which we start search</span>

<span class="sd">        Returns: placeholder id and string index, after the found placeholder.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__stashNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add node to stash &quot;&quot;&quot;</span>
        <span class="n">placeholder</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__makePlaceholder</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stashed_nodes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="n">placeholder</span>

    <span class="k">def</span> <span class="nf">__handleInline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">patternIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process string with inline patterns and replace it</span>
<span class="sd">        with placeholders</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        * data: A line of Markdown text</span>
<span class="sd">        * patternIndex: The index of the inlinePattern to start with</span>

<span class="sd">        Returns: String with placeholders.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">):</span>
            <span class="n">startIndex</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">patternIndex</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">inlinePatterns</span><span class="p">):</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">startIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__applyPattern</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">inlinePatterns</span><span class="o">.</span><span class="n">value_for_index</span><span class="p">(</span><span class="n">patternIndex</span><span class="p">),</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">patternIndex</span><span class="p">,</span> <span class="n">startIndex</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                    <span class="n">patternIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__processElementText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">subnode</span><span class="p">,</span> <span class="n">isText</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process placeholders in Element.text or Element.tail</span>
<span class="sd">        of Elements popped from self.stashed_nodes.</span>

<span class="sd">        Keywords arguments:</span>

<span class="sd">        * node: parent node</span>
<span class="sd">        * subnode: processing node</span>
<span class="sd">        * isText: bool variable, True - it&#39;s text, False - it&#39;s tail</span>

<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isText</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">subnode</span><span class="o">.</span><span class="n">text</span>
            <span class="n">subnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">subnode</span><span class="o">.</span><span class="n">tail</span>
            <span class="n">subnode</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">childResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__processPlaceholders</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">subnode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isText</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">subnode</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">subnode</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subnode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">childResult</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">newChild</span> <span class="ow">in</span> <span class="n">childResult</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">newChild</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__processPlaceholders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process string with placeholders and generate ElementTree tree.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        * data: string with placeholders instead of ElementTree elements.</span>
<span class="sd">        * parent: Element, which contains processing inline data</span>

<span class="sd">        Returns: list with ElementTree elements with applied inline patterns.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">linkText</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">text</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">text</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">parent</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="n">text</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parent</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">strartIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_prefix</span><span class="p">,</span> <span class="n">strartIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">id</span><span class="p">,</span> <span class="n">phEndIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findPlaceholder</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stashed_nodes</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stashed_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">strartIndex</span><span class="p">:</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">linkText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isString</span><span class="p">(</span><span class="n">node</span><span class="p">):</span> <span class="c"># it&#39;s Element</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">__processElementText</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">__processElementText</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c"># it&#39;s just a string</span>
                        <span class="n">linkText</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                        <span class="n">strartIndex</span> <span class="o">=</span> <span class="n">phEndIndex</span>
                        <span class="k">continue</span>

                    <span class="n">strartIndex</span> <span class="o">=</span> <span class="n">phEndIndex</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span> <span class="c"># wrong placeholder</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__placeholder_prefix</span><span class="p">)</span>
                    <span class="n">linkText</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">strartIndex</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
                    <span class="n">strartIndex</span> <span class="o">=</span> <span class="n">end</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">strartIndex</span><span class="p">:]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">):</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>We don't want to loose the AtomicString</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">linkText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__applyPattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">patternIndex</span><span class="p">,</span> <span class="n">startIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the line fits the pattern, create the necessary</span>
<span class="sd">        elements, add it to stashed_nodes.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        * data: the text to be processed</span>
<span class="sd">        * pattern: the pattern to be checked</span>
<span class="sd">        * patternIndex: index of current pattern</span>
<span class="sd">        * startIndex: string index, from which we start searching</span>

<span class="sd">        Returns: String with placeholders instead of ElementTree elements.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">getCompiledRegExp</span><span class="p">()</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">startIndex</span><span class="p">:])</span>
        <span class="n">leftData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">startIndex</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">handleMatch</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">leftData</span><span class="p">)</span><span class="o">+</span><span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isString</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">):</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>We need to process current node too</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isString</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> 
                            <span class="n">child</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handleInline</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                                                            <span class="n">patternIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                            <span class="n">child</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handleInline</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="p">,</span>
                                                            <span class="n">patternIndex</span><span class="p">)</span>

        <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stashNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pattern</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s%s%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">leftData</span><span class="p">,</span>
                             <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                             <span class="n">placeholder</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply inline patterns to a parsed Markdown tree.</span>

<span class="sd">        Iterate over ElementTree, find elements with inline tag, apply inline</span>
<span class="sd">        patterns and append newly created Elements to tree.  If you don&#39;t</span>
<span class="sd">        want to process your data with inline paterns, instead of normal string,</span>
<span class="sd">        use subclass AtomicString:</span>

<span class="sd">            node.text = markdown.AtomicString(&quot;This will not be processed.&quot;)</span>

<span class="sd">        Arguments:</span>

<span class="sd">        * tree: ElementTree object, representing Markdown tree.</span>

<span class="sd">        Returns: ElementTree object with applied inline patterns.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stashed_nodes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">currElement</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">insertQueue</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">currElement</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">AtomicString</span><span class="p">):</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__processPlaceholders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__handleInline</span><span class="p">(</span>
                                                    <span class="n">text</span><span class="p">),</span> <span class="n">child</span><span class="p">)</span>
                    <span class="n">stack</span> <span class="o">+=</span> <span class="n">lst</span>
                    <span class="n">insertQueue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="p">,</span> <span class="n">lst</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                    <span class="n">tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handleInline</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>
                    <span class="n">dumby</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
                    <span class="n">tailResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__processPlaceholders</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span> <span class="n">dumby</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dumby</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">child</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">dumby</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">child</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">currElement</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">tailResult</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">newChild</span> <span class="ow">in</span> <span class="n">tailResult</span><span class="p">:</span>
                        <span class="n">currElement</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">newChild</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">insertQueue</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">enable_attributes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">isString</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> \
                            <span class="n">inlinepatterns</span><span class="o">.</span><span class="n">handleAttributes</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> 
                                                                    <span class="n">element</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">newChild</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">markdown</span><span class="o">.</span><span class="n">enable_attributes</span><span class="p">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Processing attributes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="k">if</span> <span class="n">newChild</span><span class="o">.</span><span class="n">tail</span> <span class="ow">and</span> <span class="n">isString</span><span class="p">(</span><span class="n">newChild</span><span class="o">.</span><span class="n">tail</span><span class="p">):</span>
                            <span class="n">newChild</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> \
                                <span class="n">inlinepatterns</span><span class="o">.</span><span class="n">handleAttributes</span><span class="p">(</span><span class="n">newChild</span><span class="o">.</span><span class="n">tail</span><span class="p">,</span>
                                                                    <span class="n">element</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">newChild</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">isString</span><span class="p">(</span><span class="n">newChild</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                            <span class="n">newChild</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> \
                                <span class="n">inlinepatterns</span><span class="o">.</span><span class="n">handleAttributes</span><span class="p">(</span><span class="n">newChild</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                                                                    <span class="n">newChild</span><span class="p">)</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">newChild</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">tree</span>


<span class="k">class</span> <span class="nc">PrettifyTreeprocessor</span><span class="p">(</span><span class="n">Treeprocessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Add linebreaks to the html document. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_prettifyETree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recursively add linebreaks to ElementTree children. &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">isBlockLevel</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;code&#39;</span><span class="p">,</span> <span class="s">&#39;pre&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> \
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="ow">and</span> <span class="n">util</span><span class="o">.</span><span class="n">isBlockLevel</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span><span class="p">):</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">isBlockLevel</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">tag</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prettifyETree</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">elem</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">elem</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">elem</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">elem</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">elem</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add linebreaks to ElementTree root object. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prettifyETree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Do <br />'s seperately as they are often in the middle of
inline content and missed by _prettifyETree.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="n">brs</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="s">&#39;br&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">brs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">br</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">br</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">br</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">br</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">br</span><span class="o">.</span><span class="n">tail</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Clean up extra empty lines at end of code blocks.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="n">pres</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="s">&#39;pre&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pre</span> <span class="ow">in</span> <span class="n">pres</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pre</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;code&#39;</span><span class="p">:</span>
                <span class="n">pre</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">pre</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
