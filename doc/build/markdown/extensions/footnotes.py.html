<!DOCTYPE html>
<html>
<head>
  <title>footnotes.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../", thisFile = "build/markdown/extensions/footnotes.py", defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>footnotes.py</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">========================= FOOTNOTES =================================</span>

<span class="sd">This section adds footnote handling to markdown.  It can be used as</span>
<span class="sd">an example for extending python-markdown with relatively complex</span>
<span class="sd">functionality.  While in this case the extension is included inside</span>
<span class="sd">the module itself, it could just as easily be added from outside the</span>
<span class="sd">module.  Not that all markdown classes above are ignorant about</span>
<span class="sd">footnotes.  All footnote functionality is provided separately and</span>
<span class="sd">then added to the markdown instance at the run time.</span>

<span class="sd">Footnote functionality is attached by calling extendMarkdown()</span>
<span class="sd">method of FootnoteExtension.  The method also registers the</span>
<span class="sd">extension to allow it&#39;s state to be reset by a call to reset()</span>
<span class="sd">method.</span>

<span class="sd">Example:</span>
<span class="sd">    Footnotes[^1] have a label[^label] and a definition[^!DEF].</span>

<span class="sd">    [^1]: This is a footnote</span>
<span class="sd">    [^label]: A footnote on &quot;label&quot;</span>
<span class="sd">    [^!DEF]: The footnote for definition</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">..preprocessors</span> <span class="kn">import</span> <span class="n">Preprocessor</span>
<span class="kn">from</span> <span class="nn">..inlinepatterns</span> <span class="kn">import</span> <span class="n">Pattern</span>
<span class="kn">from</span> <span class="nn">..treeprocessors</span> <span class="kn">import</span> <span class="n">Treeprocessor</span>
<span class="kn">from</span> <span class="nn">..postprocessors</span> <span class="kn">import</span> <span class="n">Postprocessor</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">etree</span><span class="p">,</span> <span class="n">text_type</span>
<span class="kn">from</span> <span class="nn">..odict</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">FN_BACKLINK_TEXT</span> <span class="o">=</span> <span class="s">&quot;zz1337820767766393qq&quot;</span>
<span class="n">NBSP_PLACEHOLDER</span> <span class="o">=</span>  <span class="s">&quot;qq3936677670287331zz&quot;</span>
<span class="n">DEF_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[ ]{0,3}\[\^([^\]]*)\]:\s*(.*)&#39;</span><span class="p">)</span>
<span class="n">TABBED_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;((\t)|(    ))(.*)&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FootnoteExtension</span><span class="p">(</span><span class="n">Extension</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Footnote Extension. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup configs. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;PLACE_MARKER&#39;</span><span class="p">:</span>
                       <span class="p">[</span><span class="s">&quot;///Footnotes Go Here///&quot;</span><span class="p">,</span>
                        <span class="s">&quot;The text string that marks where the footnotes go&quot;</span><span class="p">],</span>
                       <span class="s">&#39;UNIQUE_IDS&#39;</span><span class="p">:</span>
                       <span class="p">[</span><span class="bp">False</span><span class="p">,</span>
                        <span class="s">&quot;Avoid name collisions across &quot;</span>
                        <span class="s">&quot;multiple calls to reset().&quot;</span><span class="p">],</span>
                       <span class="s">&quot;BACKLINK_TEXT&quot;</span><span class="p">:</span>
                       <span class="p">[</span><span class="s">&quot;&amp;#8617;&quot;</span><span class="p">,</span>
                        <span class="s">&quot;The text string that links from the footnote to the reader&#39;s place.&quot;</span><span class="p">]</span>
                       <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>In multiple invocations, emit links that don't get tangled.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_prefix</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">extendMarkdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">md_globals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add pieces to Markdown. &quot;&quot;&quot;</span>
        <span class="n">md</span><span class="o">.</span><span class="n">registerExtension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">md</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Insert a preprocessor before ReferencePreprocessor</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="n">md</span><span class="o">.</span><span class="n">preprocessors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;footnote&quot;</span><span class="p">,</span> <span class="n">FootnotePreprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                             <span class="s">&quot;&lt;reference&quot;</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Insert an inline pattern before ImageReferencePattern</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="n">FOOTNOTE_RE</span> <span class="o">=</span> <span class="s">r&#39;\[\^([^\]]*)\]&#39;</span> <span class="c"># blah blah [^1] blah</span>
        <span class="n">md</span><span class="o">.</span><span class="n">inlinePatterns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;footnote&quot;</span><span class="p">,</span> <span class="n">FootnotePattern</span><span class="p">(</span><span class="n">FOOTNOTE_RE</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span>
                              <span class="s">&quot;&lt;reference&quot;</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Insert a tree-processor that would actually add the footnote div
This must be before all other treeprocessors (i.e., inline and 
codehilite) so they can run on the the contents of the div.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="n">md</span><span class="o">.</span><span class="n">treeprocessors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;footnote&quot;</span><span class="p">,</span> <span class="n">FootnoteTreeprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                 <span class="s">&quot;_begin&quot;</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Insert a postprocessor after amp_substitute oricessor</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="n">md</span><span class="o">.</span><span class="n">postprocessors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;footnote&quot;</span><span class="p">,</span> <span class="n">FootnotePostprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                  <span class="s">&quot;&gt;amp_substitute&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear the footnotes on reset, and prepare for a distinct document. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_prefix</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">findFootnotesPlaceholder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return ElementTree Element that contains Footnote placeholder. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">finder</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;PLACE_MARKER&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">child</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;PLACE_MARKER&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">child</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="bp">False</span>
                <span class="n">finder</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
                
        <span class="n">res</span> <span class="o">=</span> <span class="n">finder</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">setFootnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store a footnote for later retrieval. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">get_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">output_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;html5&#39;</span><span class="p">,</span> <span class="s">&#39;xhtml5&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s">&#39;-&#39;</span>
        <span class="k">return</span> <span class="s">&#39;:&#39;</span>

    <span class="k">def</span> <span class="nf">makeFootnoteId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return footnote link id. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;UNIQUE_IDS&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;fn</span><span class="si">%s%d</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_separator</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_prefix</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;fn</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_separator</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makeFootnoteRefId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return footnote back-link id. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;UNIQUE_IDS&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;fnref</span><span class="si">%s%d</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_separator</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_prefix</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;fnref</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_separator</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makeFootnotesDiv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return div of footnotes as et Element. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">div</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">)</span>
        <span class="n">div</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">,</span> <span class="s">&#39;footnote&#39;</span><span class="p">)</span>
        <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="s">&quot;hr&quot;</span><span class="p">)</span>
        <span class="n">ol</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="s">&quot;ol&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">li</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">ol</span><span class="p">,</span> <span class="s">&quot;li&quot;</span><span class="p">)</span>
            <span class="n">li</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeFootnoteId</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parseChunk</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
            <span class="n">backlink</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">backlink</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">,</span> <span class="s">&quot;#&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeFootnoteRefId</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">output_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;html5&#39;</span><span class="p">,</span> <span class="s">&#39;xhtml5&#39;</span><span class="p">]:</span>
                <span class="n">backlink</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;rev&quot;</span><span class="p">,</span> <span class="s">&quot;footnote&quot;</span><span class="p">)</span> <span class="c"># Invalid in HTML5</span>
            <span class="n">backlink</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;class&quot;</span><span class="p">,</span> <span class="s">&quot;footnote-backref&quot;</span><span class="p">)</span>
            <span class="n">backlink</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Jump back to footnote </span><span class="si">%d</span><span class="s"> in the text&quot;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">backlink</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">FN_BACKLINK_TEXT</span>

            <span class="k">if</span> <span class="n">li</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">li</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;p&quot;</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="n">NBSP_PLACEHOLDER</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backlink</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backlink</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">div</span>


<span class="k">class</span> <span class="nc">FootnotePreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Find all footnote references and store for later use. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footnotes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span> <span class="o">=</span> <span class="n">footnotes</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop through lines and find, set, and remove footnote definitions.</span>

<span class="sd">        Keywords:</span>

<span class="sd">        * lines: A list of lines of text</span>

<span class="sd">        Return: A list of lines of text with footnote definitions removed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">DEF_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">fn</span><span class="p">,</span> <span class="n">_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectTabbed</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">fn</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="n">_i</span><span class="o">-</span><span class="mi">1</span> <span class="c"># skip past footnote</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">setFootnote</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">newlines</span>

    <span class="k">def</span> <span class="nf">detectTabbed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find indented text and remove indent before further proccesing.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        * lines: an array of strings</span>

<span class="sd">        Returns: a list of post processed items and the index of last line.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">blank_line</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># have we encountered a blank line yet?</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># to keep track of where we are</span>

        <span class="k">def</span> <span class="nf">detab</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">TABBED_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
               <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="c"># Non-blank line</span>
                <span class="n">detabbed_line</span> <span class="o">=</span> <span class="n">detab</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">detabbed_line</span><span class="p">:</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detabbed_line</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">blank_line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">DEF_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>not tabbed but still part of first par.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">items</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span> <span class="c"># Blank line: _maybe_ we are done.</span>
                <span class="n">blank_line</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># advance</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Find the next non-blank line</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">next_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span> <span class="c"># There is no more text; we are done.</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Check if the next non-blank line is tabbed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="n">detab</span><span class="p">(</span><span class="n">next_line</span><span class="p">):</span> <span class="c"># Yes, more work to do.</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span> <span class="c"># No, we are done.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">items</span><span class="p">,</span> <span class="n">i</span>


<span class="k">class</span> <span class="nc">FootnotePattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; InlinePattern for footnote markers in a document&#39;s body text. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">footnotes</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FootnotePattern</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span> <span class="o">=</span> <span class="n">footnotes</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sup</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;sup&quot;</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">sup</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">sup</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">makeFootnoteRefId</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">makeFootnoteId</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">output_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;html5&#39;</span><span class="p">,</span> <span class="s">&#39;xhtml5&#39;</span><span class="p">]:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="s">&#39;footnote&#39;</span><span class="p">)</span> <span class="c"># invalid in HTML5</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">,</span> <span class="s">&#39;footnote-ref&#39;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">FootnoteTreeprocessor</span><span class="p">(</span><span class="n">Treeprocessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Build and append footnote div to end of document. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footnotes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span> <span class="o">=</span> <span class="n">footnotes</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="n">footnotesDiv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">makeFootnotesDiv</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">footnotesDiv</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">findFootnotesPlaceholder</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">child</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">isText</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isText</span><span class="p">:</span>
                    <span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">footnotesDiv</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">footnotesDiv</span><span class="p">)</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">footnotesDiv</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FootnotePostprocessor</span><span class="p">(</span><span class="n">Postprocessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Replace placeholders with html entities. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footnotes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span> <span class="o">=</span> <span class="n">footnotes</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">FN_BACKLINK_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&quot;BACKLINK_TEXT&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">NBSP_PLACEHOLDER</span><span class="p">,</span> <span class="s">&quot;&amp;#160;&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">makeExtension</span><span class="p">(</span><span class="n">configs</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; Return an instance of the FootnoteExtension &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">FootnoteExtension</span><span class="p">(</span><span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">)</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
